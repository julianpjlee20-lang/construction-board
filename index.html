<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2e7d32">
    <title>å·¥ç¨‹çœ‹æ¿</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: white;
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            color: #333;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2e7d32;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }
        
        .form-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .form-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2e7d32;
            cursor: pointer;
        }
        
        .form-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2e7d32;
            cursor: pointer;
            border: none;
        }
        
        .preview-area {
            position: relative;
            width: 100%;
            min-height: 300px;
            background: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            touch-action: none;
        }
        
        .preview-area img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #999;
        }
        
        .preview-placeholder svg {
            width: 64px;
            height: 64px;
            margin-bottom: 12px;
        }
        
        .watermark {
            position: absolute;
            user-select: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            cursor: move;
        }
        
        .wm-table {
            border-collapse: collapse;
            background: #2d5f3a;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
        }
        
        .wm-table td {
            border: 2px solid white;
            padding: 6px 10px;
            font-size: 11px;
        }
        
        .wm-header {
            background: #1e4027;
            font-weight: 700;
            font-size: 13px;
            text-align: center;
        }
        
        .wm-label {
            background: #2d5f3a;
            font-weight: 600;
            white-space: nowrap;
            width: 70px;
        }
        
        .wm-value {
            background: #357a44;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: white;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            margin-top: 12px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .custom-field-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: flex-start;
        }
        
        .custom-field-item input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .custom-field-item button {
            padding: 10px 14px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .custom-field-item button:active {
            transform: scale(0.95);
        }
        
        #fileInput, #cameraInput {
            display: none;
        }
        
        .canvas-container {
            display: none;
        }
        
        .tip {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“· å·¥ç¨‹çœ‹æ¿</h1>
    </div>
    
    <div class="container">
        <!-- è¨­å®šå€ -->
        <div class="card">
            <div class="card-title">ğŸ“‹ çœ‹æ¿è¨­å®š</div>
            <div class="form-group">
                <label>å·¥ç¨‹åç¨±</label>
                <input type="text" id="projectName" placeholder="ä¾‹ï¼šå‘ä¸Šå»ºè¨­ - å…«å®…æ¡ˆ">
            </div>
            <div class="form-group">
                <label>æ–½å·¥ä½ç½®</label>
                <input type="text" id="location" placeholder="ä¾‹ï¼šB1F æ©Ÿé›»å®¤">
            </div>
            <div class="form-group">
                <label>æ–½å·¥é …ç›®</label>
                <input type="text" id="workItem" placeholder="ä¾‹ï¼šé…ç®¡å·¥ç¨‹">
            </div>
            <div class="form-group">
                <label>æ‰¿åŒ…å•†</label>
                <input type="text" id="contractor" placeholder="ä¾‹ï¼šXXç‡Ÿé€ ">
            </div>
            <div class="form-group">
                <label>å¤©æ°£</label>
                <select id="weather">
                    <option value="â˜€ï¸ æ™´">â˜€ï¸ æ™´</option>
                    <option value="â›… å¤šé›²">â›… å¤šé›²</option>
                    <option value="â˜ï¸ é™°">â˜ï¸ é™°</option>
                    <option value="ğŸŒ§ï¸ é›¨">ğŸŒ§ï¸ é›¨</option>
                    <option value="â›ˆï¸ é›·é›¨">â›ˆï¸ é›·é›¨</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="photoDate">
            </div>
            <div class="form-group">
                <label>æ‹æ”è€…</label>
                <input type="text" id="photographer" placeholder="ä¾‹ï¼šAndy">
            </div>
        </div>
        
        <!-- è‡ªè¨‚æ¬„ä½å€ -->
        <div class="card">
            <div class="card-title">â• è‡ªè¨‚æ¬„ä½</div>
            <div id="customFieldsList"></div>
            <button class="btn btn-secondary" onclick="addCustomField()" style="width: 100%; margin-top: 8px;">
                + æ–°å¢æ¬„ä½
            </button>
        </div>
        
        <!-- æ‹ç…§/é¸æ“‡å€ -->
        <div class="card">
            <div class="card-title">ğŸ“¸ æ‹ç…§</div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="openCamera()">
                    æ‹ç…§
                </button>
                <button class="btn btn-secondary" onclick="openGallery()">
                    é¸ç…§ç‰‡
                </button>
            </div>
            <input type="file" id="cameraInput" accept="image/*" capture="environment">
            <input type="file" id="fileInput" accept="image/*">
        </div>
        
        <!-- é è¦½å€ -->
        <div class="card" id="previewCard">
            <div class="card-title">ğŸ‘ï¸ é è¦½ï¼ˆå¯æ‹–å‹•çœ‹æ¿ä½ç½®ï¼‰</div>
            <div class="preview-area" id="previewArea">
                <div class="preview-placeholder" id="placeholder">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    <span>æ‹ç…§æˆ–é¸æ“‡ç…§ç‰‡</span>
                </div>
                <img id="previewImg" class="hidden">
                <div class="watermark hidden" id="watermark">
                    <table class="wm-table">
                        <tr class="wm-header">
                            <td colspan="2" id="wmProjectName">å·¥ç¨‹åç¨±</td>
                        </tr>
                        <tr id="wmLocationRow" style="display:none">
                            <td class="wm-label">æ–½å·¥ä½ç½®</td>
                            <td class="wm-value" id="wmLocation"></td>
                        </tr>
                        <tr id="wmWorkItemRow" style="display:none">
                            <td class="wm-label">æ–½å·¥é …ç›®</td>
                            <td class="wm-value" id="wmWorkItem"></td>
                        </tr>
                        <tr id="wmContractorRow" style="display:none">
                            <td class="wm-label">æ–½å·¥å» å•†</td>
                            <td class="wm-value" id="wmContractor"></td>
                        </tr>
                        <tbody id="wmCustomFields"></tbody>
                        <tr>
                            <td class="wm-label">å¤©æ°£</td>
                            <td class="wm-value" id="wmWeather">â˜€ï¸ æ™´</td>
                        </tr>
                        <tr>
                            <td class="wm-label">æ—¥æœŸ</td>
                            <td class="wm-value" id="wmDate">æ—¥æœŸ</td>
                        </tr>
                        <tr>
                            <td class="wm-label">æ‹æ”è€…</td>
                            <td class="wm-value" id="wmPhotographer">æ‹æ”è€…</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="form-group hidden" id="scaleControl">
                <label>çœ‹æ¿å¤§å°ï¼š<span id="scaleValue">100%</span></label>
                <input type="range" id="wmScale" min="50" max="150" value="100" step="5">
            </div>
            <p class="tip">ğŸ’¡ æ‹–å‹•ç¶ è‰²çœ‹æ¿èª¿æ•´ä½ç½®</p>
            <button class="btn btn-download hidden" id="downloadBtn" onclick="downloadImage()">
                ğŸ’¾ ä¸‹è¼‰ç…§ç‰‡
            </button>
        </div>
    </div>
    
    <canvas id="canvas" class="canvas-container"></canvas>
    
    <script>
        // åˆå§‹åŒ–
        const projectNameInput = document.getElementById('projectName');
        const locationInput = document.getElementById('location');
        const workItemInput = document.getElementById('workItem');
        const contractorInput = document.getElementById('contractor');
        const weatherSelect = document.getElementById('weather');
        const photographerInput = document.getElementById('photographer');
        const photoDateInput = document.getElementById('photoDate');
        const wmScaleInput = document.getElementById('wmScale');
        const scaleValueSpan = document.getElementById('scaleValue');
        const previewImg = document.getElementById('previewImg');
        const placeholder = document.getElementById('placeholder');
        const watermark = document.getElementById('watermark');
        const downloadBtn = document.getElementById('downloadBtn');
        const previewArea = document.getElementById('previewArea');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let currentImage = null;
        let watermarkPos = { x: 20, y: 20 };
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let customFields = [];
        
        // è¨­å®šä»Šå¤©æ—¥æœŸ
        photoDateInput.value = new Date().toISOString().split('T')[0];
        
        // è¼‰å…¥å„²å­˜çš„è¨­å®š
        loadSettings();
        
        // ç›£è½è¼¸å…¥è®ŠåŒ–
        projectNameInput.addEventListener('input', updateWatermark);
        locationInput.addEventListener('input', updateWatermark);
        workItemInput.addEventListener('input', updateWatermark);
        contractorInput.addEventListener('input', updateWatermark);
        weatherSelect.addEventListener('change', updateWatermark);
        photographerInput.addEventListener('input', updateWatermark);
        photoDateInput.addEventListener('input', updateWatermark);
        wmScaleInput.addEventListener('input', updateWatermarkScale);
        wmScaleInput.addEventListener('change', saveSettings);
        
        // å„²å­˜è¨­å®š
        projectNameInput.addEventListener('change', saveSettings);
        locationInput.addEventListener('change', saveSettings);
        workItemInput.addEventListener('change', saveSettings);
        contractorInput.addEventListener('change', saveSettings);
        weatherSelect.addEventListener('change', saveSettings);
        photographerInput.addEventListener('change', saveSettings);
        
        function loadSettings() {
            const saved = localStorage.getItem('boardSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                projectNameInput.value = settings.projectName || '';
                locationInput.value = settings.location || '';
                workItemInput.value = settings.workItem || '';
                contractorInput.value = settings.contractor || '';
                weatherSelect.value = settings.weather || 'â˜€ï¸ æ™´';
                photographerInput.value = settings.photographer || '';
                wmScaleInput.value = settings.wmScale || 100;
                customFields = settings.customFields || [];
                if (settings.watermarkPos) {
                    watermarkPos = settings.watermarkPos;
                }
            }
            renderCustomFields();
            updateWatermarkScale();
            updateWatermark();
        }
        
        function saveSettings() {
            const settings = {
                projectName: projectNameInput.value,
                location: locationInput.value,
                workItem: workItemInput.value,
                contractor: contractorInput.value,
                weather: weatherSelect.value,
                photographer: photographerInput.value,
                wmScale: wmScaleInput.value,
                customFields: customFields,
                watermarkPos: watermarkPos
            };
            localStorage.setItem('boardSettings', JSON.stringify(settings));
        }
        
        function updateWatermarkScale() {
            const scale = wmScaleInput.value / 100;
            scaleValueSpan.textContent = wmScaleInput.value + '%';
            watermark.style.transform = `scale(${scale})`;
            watermark.style.transformOrigin = 'top left';
        }
        
        function updateWatermark() {
            const projectName = projectNameInput.value || 'å·¥ç¨‹åç¨±';
            const location = locationInput.value;
            const workItem = workItemInput.value;
            const contractor = contractorInput.value;
            const weather = weatherSelect.value;
            const photographer = photographerInput.value || 'æ‹æ”è€…';
            const date = photoDateInput.value ? formatDate(photoDateInput.value) : 'æ—¥æœŸ';
            
            document.getElementById('wmProjectName').textContent = projectName;
            
            const wmLocation = document.getElementById('wmLocation');
            const wmLocationRow = document.getElementById('wmLocationRow');
            const wmWorkItem = document.getElementById('wmWorkItem');
            const wmWorkItemRow = document.getElementById('wmWorkItemRow');
            const wmContractor = document.getElementById('wmContractor');
            const wmContractorRow = document.getElementById('wmContractorRow');
            const wmWeather = document.getElementById('wmWeather');
            
            if (location) {
                wmLocation.textContent = location;
                wmLocationRow.style.display = '';
            } else {
                wmLocationRow.style.display = 'none';
            }
            
            if (workItem) {
                wmWorkItem.textContent = workItem;
                wmWorkItemRow.style.display = '';
            } else {
                wmWorkItemRow.style.display = 'none';
            }
            
            if (contractor) {
                wmContractor.textContent = contractor;
                wmContractorRow.style.display = '';
            } else {
                wmContractorRow.style.display = 'none';
            }
            
            wmWeather.textContent = weather;
            document.getElementById('wmDate').textContent = date;
            document.getElementById('wmPhotographer').textContent = photographer;
            
            // æ›´æ–°è‡ªè¨‚æ¬„ä½
            const wmCustomFieldsContainer = document.getElementById('wmCustomFields');
            wmCustomFieldsContainer.innerHTML = '';
            customFields.forEach(field => {
                if (field.label && field.value) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="wm-label">${field.label}</td>
                        <td class="wm-value">${field.value}</td>
                    `;
                    wmCustomFieldsContainer.appendChild(tr);
                }
            });
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
        }
        
        // è‡ªè¨‚æ¬„ä½åŠŸèƒ½
        function addCustomField() {
            customFields.push({ label: '', value: '' });
            renderCustomFields();
            saveSettings();
        }
        
        function removeCustomField(index) {
            customFields.splice(index, 1);
            renderCustomFields();
            updateWatermark();
            saveSettings();
        }
        
        function renderCustomFields() {
            const container = document.getElementById('customFieldsList');
            container.innerHTML = '';
            
            customFields.forEach((field, index) => {
                const div = document.createElement('div');
                div.className = 'custom-field-item';
                div.innerHTML = `
                    <input type="text" placeholder="æ¨™ç±¤ï¼ˆå¦‚ï¼šæ¨“å±¤ï¼‰" value="${field.label}" 
                           onchange="customFields[${index}].label = this.value; updateWatermark(); saveSettings();">
                    <input type="text" placeholder="å…§å®¹ï¼ˆå¦‚ï¼šB1Fï¼‰" value="${field.value}" 
                           onchange="customFields[${index}].value = this.value; updateWatermark(); saveSettings();">
                    <button onclick="removeCustomField(${index})">âœ•</button>
                `;
                container.appendChild(div);
            });
        }
        
        function openCamera() {
            document.getElementById('cameraInput').click();
        }
        
        function openGallery() {
            document.getElementById('fileInput').click();
        }
        
        document.getElementById('cameraInput').addEventListener('change', handleImageSelect);
        document.getElementById('fileInput').addEventListener('change', handleImageSelect);
        
        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                currentImage = new Image();
                currentImage.onload = function() {
                    showPreview();
                };
                currentImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function showPreview() {
            placeholder.classList.add('hidden');
            previewImg.classList.remove('hidden');
            previewImg.src = currentImage.src;
            watermark.classList.remove('hidden');
            document.getElementById('scaleControl').classList.remove('hidden');
            downloadBtn.classList.remove('hidden');
            
            // è¨­å®šæµ®æ°´å°ä½ç½®
            updateWatermarkPosition();
            updateWatermark();
        }
        
        function updateWatermarkPosition() {
            watermark.style.left = watermarkPos.x + 'px';
            watermark.style.top = watermarkPos.y + 'px';
        }
        
        // æ‹–å‹•åŠŸèƒ½
        watermark.addEventListener('mousedown', startDrag);
        watermark.addEventListener('touchstart', startDrag, { passive: false });
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
        
        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            
            const pos = getEventPos(e);
            const rect = watermark.getBoundingClientRect();
            dragOffset.x = pos.x - rect.left;
            dragOffset.y = pos.y - rect.top;
        }
        
        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const pos = getEventPos(e);
            const areaRect = previewArea.getBoundingClientRect();
            const wmRect = watermark.getBoundingClientRect();
            
            let newX = pos.x - areaRect.left - dragOffset.x;
            let newY = pos.y - areaRect.top - dragOffset.y;
            
            // é™åˆ¶åœ¨é è¦½å€å…§
            newX = Math.max(0, Math.min(newX, areaRect.width - wmRect.width));
            newY = Math.max(0, Math.min(newY, areaRect.height - wmRect.height));
            
            watermarkPos.x = newX;
            watermarkPos.y = newY;
            updateWatermarkPosition();
        }
        
        function endDrag() {
            if (isDragging) {
                isDragging = false;
                saveSettings();
            }
        }
        
        function getEventPos(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }
        
        function downloadImage() {
            if (!currentImage) return;
            
            // è¨­å®š canvas å¤§å°
            canvas.width = currentImage.naturalWidth;
            canvas.height = currentImage.naturalHeight;
            
            // ç•«åŸåœ–
            ctx.drawImage(currentImage, 0, 0);
            
            // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
            const scale = currentImage.naturalWidth / previewImg.clientWidth;
            
            // ç¹ªè£½å°ˆæ¥­è¡¨æ ¼å¼çœ‹æ¿
            const projectName = projectNameInput.value || 'å·¥ç¨‹åç¨±';
            const location = locationInput.value;
            const workItem = workItemInput.value;
            const contractor = contractorInput.value;
            const weather = weatherSelect.value;
            const photographer = photographerInput.value || 'æ‹æ”è€…';
            const date = photoDateInput.value ? formatDate(photoDateInput.value) : 'æ—¥æœŸ';
            
            const userScale = wmScaleInput.value / 100;
            const baseSize = scale * userScale;
            
            // è¡¨æ ¼åƒæ•¸
            const cellPadding = 10 * baseSize;
            const borderWidth = 2 * baseSize;
            const fontSize = 11 * baseSize;
            const headerFontSize = 13 * baseSize;
            const labelWidth = 70 * baseSize;
            const valueWidth = 150 * baseSize;
            const rowHeight = 24 * baseSize;
            const headerHeight = 32 * baseSize;
            
            // å»ºç«‹è¡Œè³‡æ–™
            const rows = [];
            rows.push({ type: 'header', label: projectName });
            if (location) rows.push({ type: 'data', label: 'æ–½å·¥ä½ç½®', value: location });
            if (workItem) rows.push({ type: 'data', label: 'æ–½å·¥é …ç›®', value: workItem });
            if (contractor) rows.push({ type: 'data', label: 'æ–½å·¥å» å•†', value: contractor });
            
            // åŠ å…¥è‡ªè¨‚æ¬„ä½
            customFields.forEach(field => {
                if (field.label && field.value) {
                    rows.push({ type: 'data', label: field.label, value: field.value });
                }
            });
            
            rows.push({ type: 'data', label: 'å¤©æ°£', value: weather });
            rows.push({ type: 'data', label: 'æ—¥æœŸ', value: date });
            rows.push({ type: 'data', label: 'æ‹æ”è€…', value: photographer });
            
            // è¨ˆç®—è¡¨æ ¼å¤§å°
            const tableWidth = labelWidth + valueWidth + borderWidth * 3;
            const tableHeight = headerHeight + (rows.length - 1) * rowHeight + borderWidth * rows.length;
            
            // è¨ˆç®—ä½ç½®
            let wmX = watermarkPos.x * scale;
            let wmY = watermarkPos.y * scale;
            wmX = Math.max(0, Math.min(wmX, canvas.width - tableWidth));
            wmY = Math.max(0, Math.min(wmY, canvas.height - tableHeight));
            
            // ç¹ªè£½è¡¨æ ¼
            let currentY = wmY;
            
            rows.forEach((row, index) => {
                const h = row.type === 'header' ? headerHeight : rowHeight;
                
                if (row.type === 'header') {
                    // æ¨™é¡Œè¡Œ
                    ctx.fillStyle = '#1e4027';
                    ctx.fillRect(wmX, currentY, tableWidth, h);
                    
                    // é‚Šæ¡†
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(wmX, currentY, tableWidth, h);
                    
                    // æ–‡å­—
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${headerFontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(row.label, wmX + tableWidth / 2, currentY + h / 2);
                } else {
                    // è³‡æ–™è¡Œ - æ¨™ç±¤æ¬„
                    ctx.fillStyle = '#2d5f3a';
                    ctx.fillRect(wmX, currentY, labelWidth + borderWidth, h);
                    
                    // è³‡æ–™è¡Œ - å…§å®¹æ¬„
                    ctx.fillStyle = '#357a44';
                    ctx.fillRect(wmX + labelWidth + borderWidth, currentY, valueWidth + borderWidth * 2, h);
                    
                    // é‚Šæ¡†
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = borderWidth;
                    ctx.strokeRect(wmX, currentY, labelWidth + borderWidth, h);
                    ctx.strokeRect(wmX + labelWidth + borderWidth, currentY, valueWidth + borderWidth * 2, h);
                    
                    // æ–‡å­—
                    ctx.fillStyle = 'white';
                    ctx.font = `600 ${fontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(row.label, wmX + cellPadding, currentY + h / 2);
                    
                    ctx.font = `${fontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
                    ctx.fillText(row.value, wmX + labelWidth + borderWidth + cellPadding, currentY + h / 2);
                }
                
                currentY += h;
            });
            
            // ä¸‹è¼‰
            const link = document.createElement('a');
            const filename = `${projectName}_${photoDateInput.value || 'photo'}.jpg`;
            link.download = filename;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }
        
        // è¨»å†Š Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>
